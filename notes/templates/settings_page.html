{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - StuNotes</title>
    <link rel="icon" type="image/png" href="https://dxiorsuarmdwswzyaxdy.supabase.co/storage/v1/object/public/public-assets/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'emerald-custom': {
                            50: '#e8f5e9',
                            100: '#c8e6c9',
                            500: '#4caf50',
                            600: '#43a047',
                            700: '#388e3c'
                        }
                    }
                }
            }
        }
    </script>
    {% include 'includes/theme_init.html' %}
    {% include 'includes/dark_overrides.html' %}
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slideDown { animation: slideDown 0.5s ease; }
        .animate-fadeIn { animation: fadeIn 0.6s ease; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4caf50; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #388e3c; }
    </style>
</head>
<body class="flex min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
  
  <!-- Sidebar -->
  <aside class="sidebar w-64 bg-white shadow-lg flex flex-col">
    <div class="logo p-6 border-b border-gray-200">
      <div class="flex items-center gap-2">
        <i data-lucide="book-open" class="w-6 h-6 text-emerald-600"></i>
        <span class="text-2xl font-bold text-emerald-600">StuNotes</span>
      </div>
    </div>
    
    <nav class="flex-1 p-4">
      <ul class="space-y-2">
        {% if is_admin %}
        <li>
          <a href="{% url 'notes:admin_dashboard' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-purple-50 hover:text-purple-600 transition">
            <i data-lucide="shield-check" class="w-5 h-5"></i>
            <span>Admin Dashboard</span>
          </a>
        </li>
        {% else %}
        <li>
          <a href="{% url 'notes:home' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-emerald-50 hover:text-emerald-600 transition">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span>Dashboard</span>
          </a>
        </li>
        {% endif %}
        <li>
          <a href="{% url 'notes:profile_view' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-emerald-50 hover:text-emerald-600 transition">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span>Profile</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:settings_page' %}" class="active flex items-center gap-3 px-4 py-3 bg-emerald-50 text-emerald-600 rounded-lg font-semibold">
            <i data-lucide="settings" class="w-5 h-5"></i>
            <span>Settings</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:logout' %}" class="flex items-center gap-3 px-4 py-3 text-red-600 rounded-lg hover:bg-red-50 transition">
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </nav>
    
    <div class="stats p-6 border-t border-gray-200 bg-gray-50">
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-600 font-medium">Tasks:</span>
          <span class="text-lg font-bold text-emerald-600">{{ total_tasks_count }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-600 font-medium">Notes:</span>
          <span class="text-lg font-bold text-emerald-600">{{ total_notes_sidebar }}</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main flex-1 p-8 overflow-y-auto custom-scrollbar">
    <!-- Topbar -->
    <header class="topbar flex justify-between items-center p-6 bg-white rounded-2xl shadow-lg mb-8 animate-slideDown">
      <div class="topbar-left">
        <h2 class="text-3xl font-bold text-gray-800">Settings</h2>
        <p class="text-gray-500 text-sm mt-1">Manage your account preferences</p>
      </div>
      <div class="topbar-right flex items-center gap-5">
        {% if is_admin %}
        <div class="flex items-center gap-3 px-4 py-2 bg-purple-50 rounded-lg">
          <i data-lucide="shield" class="w-5 h-5 text-purple-600"></i>
          <span class="text-sm font-semibold text-purple-600">Admin Mode</span>
        </div>
        {% endif %}
        <a href="{% url 'notes:profile_view' %}" class="profile-link">
          <img src="{% if user.profile_pic %}{{ user.profile_pic.url }}{% else %}{% static 'notes/images/default.jpg' %}{% endif %}" 
               alt="Profile" 
               class="profile-icon w-10 h-10 rounded-full object-cover border-2 border-emerald-500 hover:border-emerald-600 transition cursor-pointer shadow-md">
        </a>
      </div>
    </header>

    <!-- Settings Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fadeIn">
      <!-- Account Security -->
      <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition">
        <div class="flex items-center gap-3 mb-5 pb-4 border-b-2 border-gray-100">
          <i data-lucide="lock" class="w-6 h-6 text-emerald-600"></i>
          <h3 class="text-xl font-bold text-gray-800">Account Security</h3>
        </div>
        <div class="space-y-4">
          <button onclick="openModal('changePasswordModal')" 
                  class="w-full flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-emerald-50 transition cursor-pointer group">
            <div class="flex items-center gap-3">
              <i data-lucide="key" class="w-5 h-5 text-gray-600 group-hover:text-emerald-600"></i>
              <div>
                <h4 class="font-semibold text-gray-800">Change Password</h4>
                <p class="text-sm text-gray-500">Update your account password</p>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
          </button>
        </div>
      </div>

      <!-- Role Management (Admin Only) -->
      {% if is_admin %}
      <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition">
        <div class="flex items-center gap-3 mb-5 pb-4 border-b-2 border-gray-100">
          <i data-lucide="shield-check" class="w-6 h-6 text-purple-600"></i>
          <h3 class="text-xl font-bold text-gray-800">Role Management</h3>
        </div>
        <div class="space-y-4">
          <a href="{% url 'notes:switch_to_user_mode' %}" 
             class="w-full flex items-center justify-between p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition cursor-pointer group">
            <div class="flex items-center gap-3">
              <i data-lucide="user-round" class="w-5 h-5 text-purple-600"></i>
              <div>
                <h4 class="font-semibold text-purple-800">Switch to User Mode</h4>
                <p class="text-sm text-purple-600">View as regular user</p>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-purple-400"></i>
          </a>
          <a href="{% url 'notes:admin_dashboard' %}" 
             class="w-full flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-purple-50 transition cursor-pointer group">
            <div class="flex items-center gap-3">
              <i data-lucide="layout-dashboard" class="w-5 h-5 text-gray-600 group-hover:text-purple-600"></i>
              <div>
                <h4 class="font-semibold text-gray-800">Go to Admin Dashboard</h4>
                <p class="text-sm text-gray-500">Manage system settings</p>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
          </a>
        </div>
      </div>
      {% endif %}

      <!-- Theme Settings -->
      <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition">
        <div class="flex items-center gap-3 mb-5 pb-4 border-b-2 border-gray-100">
          <i data-lucide="palette" class="w-6 h-6 text-emerald-600"></i>
          <h3 class="text-xl font-bold text-gray-800">Appearance</h3>
        </div>
        <div class="space-y-4">
          <button id="theme-toggle-settings" 
                  class="w-full flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-emerald-50 transition cursor-pointer group">
            <div class="flex items-center gap-3">
              <i id="theme-icon-settings" data-lucide="moon" class="w-5 h-5 text-gray-600 group-hover:text-emerald-600"></i>
              <div>
                <h4 class="font-semibold text-gray-800">Theme</h4>
                <p id="theme-text-settings" class="text-sm text-gray-500">Dark Mode</p>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
          </button>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition border-2 border-red-200">
        <div class="flex items-center gap-3 mb-5 pb-4 border-b-2 border-red-100">
          <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
          <h3 class="text-xl font-bold text-red-800">Danger Zone</h3>
        </div>
        <div class="space-y-4">
          <button onclick="openModal('deleteAccountModal')" 
                  class="w-full flex items-center justify-between p-4 bg-red-50 rounded-lg hover:bg-red-100 transition cursor-pointer group">
            <div class="flex items-center gap-3">
              <i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i>
              <div>
                <h4 class="font-semibold text-red-800">Delete Account</h4>
                <p class="text-sm text-red-600">Permanently delete your account</p>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-red-400"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="modal hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] items-center justify-center">
    <div class="modal-content bg-white mx-auto my-12 p-0 w-11/12 max-w-md rounded-3xl shadow-2xl animate-slideDown">
      <div class="modal-header px-8 py-6 flex justify-between items-center bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-t-3xl text-white">
        <h2 class="text-2xl font-bold">üîí Change Password</h2>
        <span class="close-modal text-4xl font-bold cursor-pointer w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20 hover:rotate-90 transition-all" onclick="closeModal('changePasswordModal')">&times;</span>
      </div>
      <div class="modal-body p-8">
        <form method="post" action="{% url 'notes:settings_page' %}">
          {% csrf_token %}
          <div class="space-y-4">
            <div class="form-group">
              <label class="block font-semibold text-gray-800 mb-2">Old Password</label>
              {{ password_form.old_password }}
            </div>
            <div class="form-group">
              <label class="block font-semibold text-gray-800 mb-2">New Password</label>
              {{ password_form.new_password1 }}
            </div>
            <div class="form-group">
              <label class="block font-semibold text-gray-800 mb-2">Confirm New Password</label>
              {{ password_form.new_password2 }}
            </div>
            {% if password_form.errors %}
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
              <p class="text-red-800 text-sm font-semibold">Please correct the errors:</p>
              {{ password_form.errors }}
            </div>
            {% endif %}
          </div>
          <div class="flex gap-3 mt-6">
            <button type="submit" class="btn btn-primary flex-1 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl hover:-translate-y-0.5 transition-all shadow-md font-semibold">Save Changes</button>
            <button type="button" class="btn btn-secondary flex-1 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl hover:-translate-y-0.5 transition-all shadow-md font-semibold" onclick="closeModal('changePasswordModal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="modal hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] items-center justify-center">
    <div class="modal-content bg-white mx-auto my-12 p-0 w-11/12 max-w-md rounded-3xl shadow-2xl animate-slideDown">
      <div class="modal-header px-8 py-6 flex justify-between items-center bg-gradient-to-r from-red-500 to-red-600 rounded-t-3xl text-white">
        <h2 class="text-2xl font-bold">‚ö†Ô∏è Delete Account</h2>
        <span class="close-modal text-4xl font-bold cursor-pointer w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20 hover:rotate-90 transition-all" onclick="closeModal('deleteAccountModal')">&times;</span>
      </div>
      <div class="modal-body p-8">
        <div class="mb-6">
          <p class="text-gray-700 mb-4">Are you sure you want to delete your account? This action is <strong>permanent</strong> and cannot be undone.</p>
          <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
            <p class="text-red-800 text-sm font-semibold">‚ö†Ô∏è Warning: All your data will be permanently deleted:</p>
            <ul class="list-disc list-inside text-red-700 text-sm mt-2">
              <li>All tasks</li>
              <li>All notes</li>
              <li>Profile information</li>
              <li>Account settings</li>
            </ul>
          </div>
        </div>
        <form method="post" action="{% url 'notes:delete_account' %}">
          {% csrf_token %}
          <div class="flex gap-3">
            <button type="submit" class="btn btn-danger flex-1 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:-translate-y-0.5 transition-all shadow-md font-semibold">Yes, Delete My Account</button>
            <button type="button" class="btn btn-secondary flex-1 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl hover:-translate-y-0.5 transition-all shadow-md font-semibold" onclick="closeModal('deleteAccountModal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .modal {
      display: none;
    }
    
    .modal.flex {
      display: flex !important;
    }
  </style>

  <script>
    lucide.createIcons();

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    // Auto-open password modal if there were errors
    {% if should_open_modal %}
    document.addEventListener('DOMContentLoaded', function() {
      openModal('changePasswordModal');
    });
    {% endif %}

    // Theme toggle
    document.addEventListener('DOMContentLoaded', () => {
      const htmlElement = document.documentElement;
      const toggle = document.getElementById('theme-toggle-settings');
      
      if (!toggle) return;

      const icon = document.getElementById('theme-icon-settings');
      const text = document.getElementById('theme-text-settings');
      
      const isDarkInitially = htmlElement.classList.contains('dark');
      if(icon) icon.setAttribute('data-lucide', isDarkInitially ? 'sun' : 'moon');
      if(text) text.textContent = isDarkInitially ? 'Light Mode' : 'Dark Mode';
      
      lucide.createIcons();

      toggle.addEventListener('click', () => {
        const isCurrentlyDark = htmlElement.classList.contains('dark');
        const newIsDark = !isCurrentlyDark;

        htmlElement.classList.toggle('dark', newIsDark);
        localStorage.setItem('theme', newIsDark ? 'dark' : 'light');

        const newIconName = newIsDark ? 'sun' : 'moon';
        const newTextContent = newIsDark ? 'Light Mode' : 'Dark Mode';
        
        if(icon) {
          icon.setAttribute('data-lucide', newIconName);
          lucide.replace(icon);
        }
        if(text) text.textContent = newTextContent;
      });
    });
  </script>
</body>
</html>
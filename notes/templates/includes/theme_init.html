<script>
// Theme initialization: prefer server-saved user.theme when available, else use localStorage.
    (function(){
        try{
            const serverTheme = {% if user.is_authenticated %}"{{ user.theme|default:'light'|escapejs }}"{% else %}null{% endif %};
            let resolvedTheme = null;
            if(serverTheme !== null){
                try{ localStorage.setItem('theme', serverTheme); }catch(e){}
                resolvedTheme = serverTheme;
            } else {
                resolvedTheme = localStorage.getItem('theme') || 'light';
            }

            // Apply the dark class only when resolvedTheme is 'dark'
            document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
            // Expose the resolved preference to CSS so we can selectively override
            // media-driven dark rules (useful when user explicitly chose light).
            try{ document.documentElement.setAttribute('data-user-theme', resolvedTheme); }catch(e){}
        }catch(e){
            // fallback: ensure no JS error interrupts page
            try{ const theme = localStorage.getItem('theme'); if(theme === 'dark') document.documentElement.classList.add('dark'); }catch(e){}
        }
    })();
</script>

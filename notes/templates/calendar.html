{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calendar - StuNotes</title>
    <link rel="icon" type="image/png" href="https://dxiorsuarmdwswzyaxdy.supabase.co/storage/v1/object/public/public-assets/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        try { tailwind.config = tailwind.config || {}; tailwind.config.darkMode = 'class'; } catch(e){}
    </script>
    {% include 'includes/theme_init.html' %}
    {% include 'includes/dark_overrides.html' %}
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .calendar-day { min-height: 90px; }
        .event-dot { width:8px; height:8px; border-radius:999px; display:inline-block; }
    </style>
</head>
<body class="flex min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800">
  <!-- Sidebar (duplicate style to match app) -->
  <aside class="sidebar w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col">
    <div class="logo p-6 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-2">
        <i data-lucide="book-open" class="w-6 h-6 text-emerald-600 dark:text-emerald-400"></i>
        <span class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">StuNotes</span>
      </div>
    </div>
    <nav class="flex-1 p-4">
      <ul class="space-y-2">
        <li>
          <a href="{% url 'notes:home' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/30 hover:text-emerald-600 dark:hover:text-emerald-400 transition">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:profile_view' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/30 hover:text-emerald-600 dark:hover:text-emerald-400 transition">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span>Profile</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:notes_list' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/30 hover:text-emerald-600 dark:hover:text-emerald-400 transition">
            <i data-lucide="file-text" class="w-5 h-5"></i>
            <span>All Notes</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:calendar' %}" class="active flex items-center gap-3 px-4 py-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg font-semibold">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <span>Calendar</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:settings_page' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/30 hover:text-emerald-600 dark:hover:text-emerald-400 transition">
            <i data-lucide="settings" class="w-5 h-5"></i>
            <span>Settings</span>
          </a>
        </li>
        <li>
          <a href="{% url 'notes:logout' %}" class="flex items-center gap-3 px-4 py-3 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition">
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </nav>
    <div class="stats p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Tasks:</span>
          <span class="text-lg font-bold text-emerald-600 dark:text-emerald-400">{{ total_tasks_count }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Notes:</span>
          <span class="text-lg font-bold text-emerald-600 dark:text-emerald-400">{{ total_notes_sidebar }}</span>
        </div>
      </div>
    </div>
  </aside>

  <main class="main flex-1 p-8 overflow-y-auto custom-scrollbar">
    <header class="flex justify-between items-center p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">{{ month }} {{ year }} â€” Calendar</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">View deadlines, reminders and scheduled times.</p>
      </div>
      <div class="text-right">
        <div class="text-sm text-gray-500 dark:text-gray-300">Current time</div>
        <div id="live-clock" class="text-lg font-semibold text-gray-800 dark:text-white">--:--:--</div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="col-span-2 bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
        <div class="grid grid-cols-7 gap-2 text-center mb-3 text-sm text-gray-600 dark:text-gray-300">
          <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div class="grid grid-cols-7 gap-3">
          {% for week in month_cells %}
            {% for day in week %}
              <div class="calendar-day border rounded-lg p-2 text-left bg-white dark:bg-gray-700">
                {% if day.day != 0 %}
                  <div class="flex justify-between items-start">
                    <span class="text-sm font-semibold text-gray-800 dark:text-white">{{ day.day }}</span>
                  </div>
                  <div class="mt-2 text-xs space-y-1">
                    {% for ev in day.events %}
                      <div class="flex items-center gap-2">
                          <span class="event-dot bg-emerald-500"></span>
                          <a href="{{ ev.url }}" data-url="{{ ev.url }}" class="event-link truncate block text-xs text-gray-700 dark:text-gray-200">{{ ev.title }}</a>
                      </div>
                    {% empty %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </section>

      <aside class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
        <!-- Mini calendar -->
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Mini Calendar</h3>
          <div class="grid grid-cols-7 gap-1 mt-2 text-xs text-center text-gray-500">
            {% for week in month_cells %}
              {% for day in week %}
                {% if day.day != 0 %}
                  {% if day.day == now.day %}
                    <div class="p-2 rounded bg-emerald-50 text-emerald-700 font-semibold">{{ day.day }}</div>
                  {% else %}
                    <div class="p-2 rounded bg-transparent">{{ day.day }}</div>
                  {% endif %}
                {% else %}
                  <div class="p-2">&nbsp;</div>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>

        <!-- To-dos Today -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white">To-dos Today</h3>
          <div class="mt-3 space-y-2 text-sm text-gray-700 dark:text-gray-200">
            {% if todos_today %}
              {% for ev in todos_today %}
                <div class="p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                  <div class="flex items-center justify-between">
                    <a href="{{ ev.url }}" data-url="{{ ev.url }}" class="event-link font-medium truncate">{{ ev.title }}</a>
                    <div class="text-xs text-gray-500">{{ ev.datetime|date:"H:i" }}</div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ ev.type|capfirst }}</div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-sm text-gray-500">No to-dos for today.</div>
            {% endif %}
          </div>
        </div>

        <!-- To-dos Tomorrow -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white">To-dos Tomorrow</h3>
          <div class="mt-3 space-y-2 text-sm text-gray-700 dark:text-gray-200">
            {% if todos_tomorrow %}
              {% for ev in todos_tomorrow %}
                <div class="p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                  <div class="flex items-center justify-between">
                    <a href="{{ ev.url }}" data-url="{{ ev.url }}" class="event-link font-medium truncate">{{ ev.title }}</a>
                    <div class="text-xs text-gray-500">{{ ev.datetime|date:"H:i" }}</div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ ev.type|capfirst }}</div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-sm text-gray-500">No to-dos for tomorrow.</div>
            {% endif %}
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Right-side slide-in panel for edit form -->
  <div id="right-panel" class="fixed top-0 right-0 h-full w-2/5 bg-gray-100 dark:bg-gray-800 shadow-xl z-50 transform translate-x-full transition-transform">
    <div id="right-panel-content" class="h-full"></div>
  </div>

  <script>
    // Live clock
    function updateClock(){
      const el = document.getElementById('live-clock');
      const now = new Date();
      const s = now.toLocaleTimeString();
      if(el) el.textContent = s;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Helper to initialize icons
    lucide.createIcons();

    // Load edit form into right panel when clicking event links
    function openRightPanelWithUrl(url){
      const panel = document.getElementById('right-panel');
      const content = document.getElementById('right-panel-content');
      // ensure panel param present
      const sep = url.includes('?') ? '&' : '?';
      const panelUrl = url + sep + 'panel=1';

      fetch(panelUrl, { headers: { 'x-requested-with': 'XMLHttpRequest' } })
        .then(r => {
          if(!r.ok) throw new Error('Network response not ok');
          return r.text();
        })
        .then(html => {
          content.innerHTML = html;
          // show panel
          panel.classList.remove('translate-x-full');
          panel.classList.add('translate-x-0');
          // initialize icons inside injected html
          lucide.createIcons();
          // attach close handler (delegated)
          const closeBtn = document.getElementById('close-panel');
          if(closeBtn){
            closeBtn.addEventListener('click', (e) => {
              panel.classList.remove('translate-x-0');
              panel.classList.add('translate-x-full');
            });
          }
        })
        .catch(err => {
          console.error('Failed to load panel:', err);
        });
    }

    document.querySelectorAll('.event-link').forEach(a => {
      a.addEventListener('click', function(e){
        e.preventDefault();
        const url = this.getAttribute('data-url') || this.href;
        openRightPanelWithUrl(url);
      });
    });
  </script>
</body>
</html>
